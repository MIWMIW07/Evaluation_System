# Enhanced .htaccess for Teacher Evaluation System

# Enable mod_rewrite
RewriteEngine On

# Force HTTPS (if not already enabled on server)
RewriteCond %{HTTPS} !=on
RewriteCond %{REQUEST_URI} !^/healthcheck.php
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data:;"
</IfModule>

# Prevent access to sensitive files
<FilesMatch "\\.(env|log|htaccess|htpasswd|ini|php|sql|tpl|txt|xml)$">
    Order allow,deny
    Deny from all
</FilesMatch>

# Restrict access to specific directories
<DirectoryMatch "(^|/)(\\.git|config|logs|temp|vendor)(/|$)">
    Order allow,deny
    Deny from all
</DirectoryMatch>

# Protect against SQL injection attempts
RewriteCond %{QUERY_STRING} (;|<|>|'|"|\\)|%0A|%0D|%22|%27|%3C|%3E|%00).*(/\\*|union|select|insert|drop|delete|update|cast|create|char|convert|alter|declare|order|script|iframe) [NC,OR]
RewriteCond %{QUERY_STRING} \\.\\./\\.\\. [OR]
RewriteCond %{QUERY_STRING} (localhost|loopback|127\\.0\\.0\\.1) [NC,OR]
RewriteCond %{QUERY_STRING} \\=PHP[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12} [NC]
RewriteRule ^(.*)$ - [F,L]

# Prevent directory browsing
Options -Indexes

# Set default charset
AddDefaultCharset UTF-8

# Enable compression
<IfModule mod_deflate.c>
    <IfModule mod_filter.c>
        AddOutputFilterByType DEFLATE "application/atom+xml" \\
          "application/javascript" \\
          "application/json" \\
          "application/ld+json" \\
          "application/manifest+json" \\
          "application/rdf+xml" \\
          "application/rss+xml" \\
          "application/schema+json" \\
          "application/vnd.geo+json" \\
          "application/vnd.ms-fontobject" \\
          "application/x-font-ttf" \\
          "application/x-javascript" \\
          "application/x-web-app-manifest+json" \\
          "application/xhtml+xml" \\
          "application/xml" \\
          "font/eot" \\
          "font/opentype" \\
          "image/bmp" \\
          "image/svg+xml" \\
          "image/vnd.microsoft.icon" \\
          "image/x-icon" \\
          "text/cache-manifest" \\
          "text/css" \\
          "text/html" \\
          "text/javascript" \\
          "text/plain" \\
          "text/vcard" \\
          "text/vnd.rim.location.xloc" \\
          "text/vtt" \\
          "text/x-component" \\
          "text/x-cross-domain-policy" \\
          "text/xml"
    </IfModule>
</IfModule>

# Cache static files
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/ico "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType font/ttf "access plus 1 month"
    ExpiresByType font/woff "access plus 1 month"
    ExpiresByType font/woff2 "access plus 1 month"
</IfModule>

# Pretty URLs
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^([^/]+)/?$ $1.php [L,QSA]
